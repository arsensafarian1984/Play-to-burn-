<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">

<title>TON Burner</title>

<!-- Telegram SDK -->
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<!-- Adsgram SDK -->
<script src="https://adsgram.ai/js/adsgram-ad-sdk.js"></script>

<style>
body {
    margin: 0;
    background: #000;
    font-family: Arial, sans-serif;
    overflow: hidden;
    user-select: none;
}

canvas {
    display: block;
    margin: auto;
    background: #000;
}

#ui {
    position: absolute;
    top: 10px;
    width: 100%;
    text-align: center;
    color: #00d4ff;
    font-weight: bold;
    pointer-events: none;
}

#menu {
    position: absolute;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    color: #fff;
}

button {
    padding: 14px 36px;
    border-radius: 40px;
    border: none;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
}

#startBtn {
    background: #00d4ff;
    color: #000;
}

#adBtn {
    background: #ffcc00;
    color: #000;
    display: none;
}

#adBtn:disabled {
    background: #555;
    color: #888;
}

#policy {
    font-size: 11px;
    opacity: 0.6;
    text-align: center;
    max-width: 280px;
    line-height: 1.4;
}
</style>
</head>

<body>

<div id="ui">
    SCORE: <span id="score">0</span> |
    BEST: <span id="best">0</span>
</div>

<div id="menu">
    <h1 style="color:#00d4ff">TON BURNER</h1>

    <button id="startBtn">START GAME üî•</button>

    <button id="adBtn">Watch Ad & Get +10 üéÅ</button>

    <div id="policy">
        This game stores score locally on your device.<br>
        Ads are optional and provided by Adsgram.<br>
        No personal data is collected.
    </div>
</div>

<canvas id="game" width="640" height="360"></canvas>

<script>
/* ================= TELEGRAM SAFE INIT ================= */
const tg = window.Telegram?.WebApp;
if (tg) {
    tg.ready();
    tg.expand();
}

/* ================= ADSGRAM INIT ================= */
/* ÿ®ÿπÿØ ÿßÿ≤ ÿ™ÿ£€å€åÿØÿå ÿ®ŸÑÿß⁄© ÿ¢€åÿØ€å ÿ¨ÿØ€åÿØ ÿ±ÿß ÿ¨ÿß€å⁄Øÿ≤€åŸÜ ⁄©ŸÜ */
const AdController =
    window.AdsgramAdController
        ? window.AdsgramAdController.init({ blockId: "YOUR_NEW_BLOCK_ID" })
        : null;

/* ================= CANVAS ================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

/* ================= GAME STATE ================= */
let bird;
let pipes = [];
let score = 0;
let active = false;
let speed = 3.5;

const GAP = 220;

/* ================= AD RULES ================= */
const AD_REQUIRED_PLAYTIME = 2 * 60 * 1000; // 2 minutes total play
const AD_COOLDOWN = 4 * 60 * 60 * 1000;     // 4 hours

let sessionPlayTime = 0; // ŸÖÿ¨ŸÖŸàÿπ ÿ≤ŸÖÿßŸÜ ÿ®ÿßÿ≤€å
let roundStartTime = 0;  // ÿ¥ÿ±Ÿàÿπ Ÿáÿ± ÿ±ÿßŸÜÿØ

/* ================= BEST SCORE ================= */
const bestEl = document.getElementById("best");
bestEl.textContent = localStorage.getItem("ton_best") || 0;

/* ================= IMAGES (FAIL-SAFE) ================= */
const imgPlayer = new Image();
imgPlayer.src = "logo.png";

const imgPipe = new Image();
imgPipe.src = "fire.png";

/* ================= GAME FUNCTIONS ================= */
function startGame(bonus = 0) {
    bird = { x: 80, y: 180, v: 0 };
    pipes = [];
    score = bonus;
    speed = 3.5;
    active = true;

    roundStartTime = Date.now(); // ÿ¥ÿ±Ÿàÿπ ÿß€åŸÜ ÿ±ÿßŸÜÿØ

    document.getElementById("score").textContent = score;
    document.getElementById("menu").style.display = "none";
    document.getElementById("adBtn").style.display = "none";
}

function endGame() {
    if (active) {
        sessionPlayTime += Date.now() - roundStartTime;
    }

    active = false;
    document.getElementById("menu").style.display = "flex";

    const best = Number(localStorage.getItem("ton_best") || 0);
    if (score > best) {
        localStorage.setItem("ton_best", score);
        bestEl.textContent = score;
    }

    updateAdButtonVisibility();
}

function updateAdButtonVisibility() {
    const adBtn = document.getElementById("adBtn");
    adBtn.style.display = "none";

    const lastAdTime = Number(localStorage.getItem("last_ad_time") || 0);
    const now = Date.now();

    if (now - lastAdTime < AD_COOLDOWN) return;
    if (sessionPlayTime < AD_REQUIRED_PLAYTIME) return;

    adBtn.style.display = "block";
}

/* ================= GAME LOOP ================= */
function update() {
    if (!active) return;

    bird.v += 0.5;
    bird.y += bird.v;

    if (!pipes.length || pipes[pipes.length - 1].x < 360) {
        pipes.push({
            x: 640,
            top: Math.random() * 120 + 60,
            passed: false
        });
    }

    pipes.forEach(p => {
        p.x -= speed;

        if (
            bird.x + 15 > p.x &&
            bird.x - 15 < p.x + 50 &&
            (bird.y < p.top || bird.y > p.top + GAP)
        ) {
            endGame();
        }

        if (!p.passed && p.x < bird.x) {
            p.passed = true;
            score++;
            speed += 0.08;
            document.getElementById("score").textContent = score;
        }
    });

    if (pipes[0]?.x < -60) pipes.shift();
    if (bird.y < 0 || bird.y > 360) endGame();
}

function draw() {
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, 640, 360);

    if (imgPlayer.complete && imgPlayer.width) {
        ctx.drawImage(imgPlayer, bird.x - 20, bird.y - 20, 40, 40);
    } else {
        ctx.fillStyle = "#00d4ff";
        ctx.fillRect(bird.x - 20, bird.y - 20, 40, 40);
    }

    pipes.forEach(p => {
        ctx.fillStyle = "orange";
        ctx.fillRect(p.x, 0, 50, p.top);
        ctx.fillRect(p.x, p.top + GAP, 50, 360);
    });
}

function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}
loop();

/* ================= INPUT ================= */
window.addEventListener("mousedown", () => active && (bird.v = -8));
window.addEventListener("touchstart", e => {
    if (active) {
        bird.v = -8;
        e.preventDefault();
    }
});

/* ================= BUTTONS ================= */
document.getElementById("startBtn").onclick = () => {
    startGame(0);
};

document.getElementById("adBtn").onclick = () => {
    if (!AdController) {
        alert("Ads are not available right now.");
        return;
    }

    AdController.show().then(() => {
        localStorage.setItem("last_ad_time", Date.now());
        sessionPlayTime = 0; // ÿ±€åÿ≥ÿ™ ÿ™ÿß€åŸÖÿ± €≤ ÿØŸÇ€åŸÇŸá
        startGame(10);
    }).catch(() => {
        alert("Ad failed to load.");
    });
};
</script>

</body>
</html>
