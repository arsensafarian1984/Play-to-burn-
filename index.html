<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8">
<title>Flappy Fire</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  background: #111;
  color: #fff;
  font-family: sans-serif;
  text-align: center;
}
canvas {
  background: #222;
  display: block;
  margin: auto;
}
button {
  padding: 12px 20px;
  font-size: 16px;
  border: none;
  border-radius: 8px;
  margin: 8px;
  cursor: pointer;
}
#startBtn { background: #00c853; }
#adBtn {
  background: #ffd600;
  display: none;
}
#policy {
  font-size: 12px;
  color: #aaa;
  max-width: 320px;
  margin: 10px auto;
}
</style>
</head>

<body>

<canvas id="game" width="360" height="520"></canvas>

<button id="startBtn">Start Game</button>
<button id="adBtn">Watch Ad (+10)</button>

<div id="policy">
با شروع بازی شما با نمایش تبلیغ برای دریافت امتیاز موافقت می‌کنید.
تبلیغ اختیاری است و فقط پس از پایان بازی فعال می‌شود.
</div>

<script>
/* ================== ADZGRAM TEST ================== */
window.Adzgram = {
  showAd: function(blockId, onSuccess, onFail) {
    console.log("Adzgram TEST:", blockId);
    // شبیه‌سازی تبلیغ تست
    setTimeout(() => {
      if (blockId === 2340) {
        console.log("TEST AD SHOWN");
        onSuccess();
      } else {
        onFail();
      }
    }, 1000);
  }
};

/* ================== GAME ================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

let bird, pipes, score;
let running = false;
let gameOver = false;

let lastTime = 0;
let totalPlayTime = 0; // مجموع زمان بازی
let lastFrame = 0;

const GAP = 150; // دهانه قابل عبور
const PIPE_WIDTH = 50;

function resetGame() {
  bird = { x: 80, y: 260, vy: 0 };
  pipes = [];
  score = 0;
  gameOver = false;
  lastTime = performance.now();
}

function spawnPipe() {
  const min = 80;
  const max = canvas.height - GAP - 80;
  const topHeight = Math.random() * (max - min) + min;

  pipes.push({
    x: canvas.width,
    top: topHeight,
    bottom: canvas.height - (topHeight + GAP),
    passed: false
  });
}

function drawFirePipe(x, y, w, h, flip=false) {
  ctx.save();
  ctx.translate(x + w/2, y + h/2);
  if (flip) ctx.rotate(Math.PI);
  ctx.fillStyle = "#ff5722";
  ctx.beginPath();
  ctx.moveTo(-w/2, h/2);
  ctx.lineTo(0, -h/2);
  ctx.lineTo(w/2, h/2);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function update(dt) {
  bird.vy += 900 * dt;
  bird.y += bird.vy * dt;

  if (bird.y < 0 || bird.y > canvas.height) endGame();

  if (pipes.length === 0 || pipes[pipes.length-1].x < 180) {
    spawnPipe();
  }

  pipes.forEach(p => {
    p.x -= 180 * dt;

    if (!p.passed && p.x + PIPE_WIDTH < bird.x) {
      score++;
      p.passed = true;
    }

    // collision
    if (
      bird.x > p.x &&
      bird.x < p.x + PIPE_WIDTH &&
      (bird.y < p.top || bird.y > p.top + GAP)
    ) {
      endGame();
    }
  });

  pipes = pipes.filter(p => p.x > -PIPE_WIDTH);
}

function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  // bird
  ctx.fillStyle = "#00e5ff";
  ctx.beginPath();
  ctx.arc(bird.x, bird.y, 10, 0, Math.PI*2);
  ctx.fill();

  // pipes
  pipes.forEach(p => {
    drawFirePipe(p.x, 0, PIPE_WIDTH, p.top, false);
    drawFirePipe(p.x, canvas.height - p.bottom, PIPE_WIDTH, p.bottom, true);
  });

  ctx.fillStyle = "#fff";
  ctx.fillText("Score: " + score, 10, 20);
}

function loop(t) {
  if (!running) return;

  const dt = (t - lastFrame) / 1000;
  lastFrame = t;

  update(dt);
  draw();

  requestAnimationFrame(loop);
}

function endGame() {
  running = false;
  gameOver = true;
  document.getElementById("startBtn").style.display = "inline-block";

  if (totalPlayTime >= 60) {
    document.getElementById("adBtn").style.display = "inline-block";
  }
}

/* ================== EVENTS ================== */
document.getElementById("startBtn").onclick = () => {
  resetGame();
  running = true;
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("adBtn").style.display = "none";
  lastFrame = performance.now();
  requestAnimationFrame(loop);
};

document.getElementById("adBtn").onclick = () => {
  window.Adzgram.showAd(
    2340,
    () => {
      score += 10;
      document.getElementById("adBtn").style.display = "none";
      alert("10 امتیاز اضافه شد");
    },
    () => {
      alert("تبلیغ در دسترس نیست");
    }
  );
};

document.addEventListener("click", () => {
  if (running) bird.vy = -300;
});

/* ================== TIME TRACK ================== */
setInterval(() => {
  if (running) totalPlayTime++;
}, 1000);
</script>

</body>
</html>
